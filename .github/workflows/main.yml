name: Setup Proxy Machine

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: 🛠️ Checkout
        uses: actions/checkout@v3
        with:
          fetch-depth: 1
          persist-credentials: true

      - name: 🔄 Install
        run: |
          sudo apt update && sudo apt install -y python3 python3-pip python3-venv curl netcat-traditional
          python3 -m venv env
          source env/bin/activate
          pip install -r requirements.txt 2>/dev/null || true

      - name: 🚀 Start Proxy
        run: |
          source env/bin/activate
          pkill -f "python3 start.py" || true
          nohup python3 start.py > start.log 2>&1 &
          sleep 20

      - name: 🔄 Update Proxies
        run: |
          set -e
          mkdir -p Proxies
          
          # Download proxies
          for type in http https socks4 socks5; do
            for i in {1..3}; do
              if curl -s --connect-timeout 20 "http://127.0.0.1:8000/proxy/${type}?time=2&minutes=10&format=text" -o "Proxies/${type}.txt" && [ -s "Proxies/${type}.txt" ]; then
                echo "✅ Downloaded $type"
                break
              fi
              sleep 5
            done
          done

          # Git Sync
          git config --global user.name "neganok"
          git config --global user.email "hackersvn1@gmail.com"
          git add Proxies/ data.db 2>/dev/null || true
          
          if ! git diff --cached --quiet; then
            git commit -m "🔄 Update $(date +'%H:%M:%S')"
            for i in {1..3}; do
              git pull origin main && git push origin main && break
              git reset --hard origin/main
              sleep 10
            done
          fi

          # Main Loop
          for cycle in {1..299}; do
            sleep 60
            if nc -z -w 10 127.0.0.1 8000; then
              for type in http https socks4 socks5; do
                curl -s --connect-timeout 20 "http://127.0.0.1:8000/proxy/${type}?time=2&minutes=10&format=text" -o "Proxies/${type}.txt" || true
              done
              git add Proxies/ data.db 2>/dev/null || true
              git diff --cached --quiet || git commit -m "🔄 Update $(date +'%H:%M:%S')" && git pull origin main && git push origin main || true
            fi
          done

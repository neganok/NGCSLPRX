name: Setup Proxy Machine

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: üõ†Ô∏è Checkout repository (Safe Mode)
        uses: actions/checkout@v3
        with:
          fetch-depth: 1  # Gi·∫£m depth ƒë·ªÉ tr√°nh l·ªói object
          clean: true

      - name: üîÑ C√†i ƒë·∫∑t h·ªá th·ªëng
        run: |
          sudo apt update && sudo apt install -y python3 python3-pip python3-venv curl netcat-traditional

      - name: üè∞Ô∏è Thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng
        run: |
          python3 -m venv env
          source env/bin/activate
          pip install --upgrade pip
          test -f requirements.txt && pip install -r requirements.txt

      - name: üöÄ Kh·ªüi ƒë·ªông proxy
        run: |
          source env/bin/activate
          nohup python3 start.py > start.log 2>&1 &
          sleep 20  # TƒÉng th·ªùi gian ch·ªù kh·ªüi ƒë·ªông

      - name: üîÑ Proxy Update Engine
        run: |
          set -e
          mkdir -p Proxies
          
          # H√†m ki·ªÉm tra k·∫øt n·ªëi proxy server
          check_proxy_server() {
            for i in {1..10}; do
              if nc -z -w 5 127.0.0.1 8000; then
                return 0
              fi
              sleep 10
              echo "‚åõ ƒê·ª£i proxy server... ($i/10)"
            done
            echo "‚ùå Proxy server kh√¥ng ph·∫£n h·ªìi sau 10 l·∫ßn th·ª≠"
            return 1
          }

          # H√†m t·∫£i proxy ƒë∆°n gi·∫£n
          download_proxy() {
            curl -s --connect-timeout 15 --retry 2 "http://127.0.0.1:8000/proxy/$1?time=2&minutes=10&format=text" -o "Proxies/$1.txt"
          }

          # H√†m ƒë·ªìng b·ªô Git c·ª±c k·ª≥ ƒë∆°n gi·∫£n
          git_sync() {
            git config --global user.name "neganok"
            git config --global user.email "hackersvn1@gmail.com"
            
            # T·∫°o commit m·ªõi ho√†n to√†n
            git checkout --orphan temp_branch
            git add -A
            git commit -m "üîÑ Proxy update $(date +'%Y%m%d-%H%M%S')"
            
            # Force push ƒë·ªÉ tr√°nh m·ªçi xung ƒë·ªôt
            git branch -D main
            git branch -m main
            git push -f origin main
          }

          # Main workflow
          for cycle in {1..300}; do
            echo "üîÑ Cycle $cycle"
            
            # Ki·ªÉm tra proxy server
            check_proxy_server || continue
            
            # T·∫£i c√°c lo·∫°i proxy
            for type in http https socks4 socks5; do
              if download_proxy "$type" && [ -s "Proxies/$type.txt" ]; then
                echo "‚úÖ $type: OK"
              else
                echo "‚ö†Ô∏è $type: Failed"
                rm -f "Proxies/$type.txt"
              fi
            done

            # ƒê·ªìng b·ªô v·ªõi Git m·ªói 5 chu k·ª≥
            if (( cycle % 5 == 0 )); then
              echo "üíæ ƒêang ƒë·ªìng b·ªô d·ªØ li·ªáu..."
              git_sync || echo "‚ö†Ô∏è ƒê·ªìng b·ªô th·∫•t b·∫°i, ti·∫øp t·ª•c chu k·ª≥ sau"
            fi
            
            sleep 60
          done

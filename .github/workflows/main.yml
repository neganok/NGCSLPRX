name: Setup Proxy Machine

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ› ï¸ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true

      - name: ðŸ”„ CÃ i Ä‘áº·t há»‡ thá»‘ng
        run: |
          sudo apt update && sudo apt install -y python3 python3-pip python3-venv curl netcat-traditional

      - name: ðŸ°ï¸ Thiáº¿t láº­p mÃ´i trÆ°á»ng
        run: |
          python3 -m venv env
          source env/bin/activate
          pip install --upgrade pip
          test -f requirements.txt && pip install -r requirements.txt

      - name: ðŸš€ Khá»Ÿi Ä‘á»™ng proxy
        run: |
          source env/bin/activate
          nohup python3 start.py > start.log 2>&1 &
          sleep 15

      - name: ðŸ”‘ Cáº¥u hÃ¬nh Git
        run: |
          git config --global user.name "neganok"
          git config --global user.email "hackersvn1@gmail.com"
          git config --global pull.rebase false

      - name: ðŸ”„ Cáº­p nháº­t proxy (á»•n Ä‘á»‹nh)
        run: |
          set -e
          mkdir -p Proxies
          
          # HÃ m táº£i proxy vá»›i retry vÃ  kiá»ƒm tra
          safe_proxy_download() {
            local type=$1
            local max_retries=3
            local timeout=10
            
            for ((i=1; i<=max_retries; i++)); do
              if curl -s --connect-timeout $timeout "http://127.0.0.1:8000/proxy/${type}?time=2&minutes=10&format=text" -o "Proxies/${type}.tmp" && 
                 [ -s "Proxies/${type}.tmp" ]; then
                mv "Proxies/${type}.tmp" "Proxies/${type}.txt"
                echo "âœ… [$type] Táº£i thÃ nh cÃ´ng (láº§n $i)"
                return 0
              fi
              echo "âš ï¸ [$type] Lá»—i láº§n $i, chá» 5s..."
              sleep 5
            done
            echo "âŒ [$type] KhÃ´ng thá»ƒ táº£i sau $max_retries láº§n"
            return 1
          }

          # HÃ m push an toÃ n
          safe_git_push() {
            local max_attempts=3
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              git fetch origin
              git reset --hard origin/main
              
              if git diff --quiet && git diff --cached --quiet; then
                echo "â„¹ï¸ KhÃ´ng cÃ³ thay Ä‘á»•i Ä‘á»ƒ push"
                return 0
              fi
              
              git add -A
              git commit -m "ðŸ”„ Auto-update $(date +'%Y-%m-%d %H:%M:%S')" || true
              
              if git pull origin main --no-rebase && git push origin main; then
                echo "âœ… Push thÃ nh cÃ´ng!"
                return 0
              else
                echo "âš ï¸ Push tháº¥t báº¡i láº§n $attempt, Ä‘ang reset..."
                git reset --hard HEAD~1 || true
                git clean -fd
                sleep 10
                ((attempt++))
              fi
            done
            
            echo "âŒ KhÃ´ng thá»ƒ push sau $max_attempts láº§n"
            return 1
          }

          # VÃ²ng láº·p chÃ­nh
          for cycle in $(seq 1 300); do
            echo "ðŸ”„ Chu ká»³ $cycle/300"
            
            # Kiá»ƒm tra proxy server
            if ! nc -z -w 10 127.0.0.1 8000; then
              echo "âŒ Proxy chÆ°a sáºµn sÃ ng, chá» 30s..."
              sleep 30
              continue
            fi

            # Táº£i táº¥t cáº£ proxy
            for proxy_type in http https socks4 socks5; do
              safe_proxy_download $proxy_type || continue
            done

            # Xá»­ lÃ½ data.db náº¿u cÃ³
            [ -f "data.db" ] && git add data.db

            # Äá»“ng bá»™ vá»›i Git
            safe_git_push || true
            
            sleep 60
          done

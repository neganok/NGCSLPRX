name: Proxy Master

on:
  schedule:
    - cron: '0 */5 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: CÃ i Ä‘áº·t mÃ´i trÆ°á»ng
        run: |
          echo "ğŸ› ï¸ Äang cÃ i Ä‘áº·t mÃ´i trÆ°á»ng..."
          pip install -r requirements.txt
          nohup python3 start.py > start.log 2>&1 &
          sleep 10
          echo "âœ… CÃ i Ä‘áº·t mÃ´i trÆ°á»ng hoÃ n táº¥t!"

      - name: Cáº­p nháº­t tá»± Ä‘á»™ng
        run: |
          echo "âš™ï¸ Thiáº¿t láº­p thÃ´ng tin Git..."
          git config --global user.name "neganok"
          git config --global user.email "hackersvn1@gmail.com"
          
          COUNT=0
          while true; do
            COUNT=$((COUNT + 1))
            echo "\nğŸ” Báº®T Äáº¦U Láº¦N CHáº Y THá»¨ $COUNT - $(date +'%H:%M:%S %d/%m/%Y')"
            
            # Táº£i proxies
            echo "ğŸ“¥ Äang táº£i proxies má»›i..."
            mkdir -p Proxies
            for t in http https socks4 socks5; do
              echo "  â†³ Äang táº£i $t..."
              curl -s "http://127.0.0.1:8000/proxy/$t?time=3&minutes=15&format=text" -o "Proxies/$t.txt" || echo "  âŒ Lá»—i khi táº£i $t"
            done
            
            # Xá»­ lÃ½ Git
            echo "ğŸ”„ Äang kiá»ƒm tra thay Ä‘á»•i..."
            git add Proxies/ data.db
            
            if ! git diff --cached --quiet; then
              echo "ğŸ“ PhÃ¡t hiá»‡n thay Ä‘á»•i, Ä‘ang táº¡o commit..."
              git commit -m "ğŸ”„ Cáº­p nháº­t tá»± Ä‘á»™ng lÃºc $(date +'%H:%M:%S %d/%m/%Y')"
              
              echo "ğŸ“¤ Äang Ä‘áº©y thay Ä‘á»•i lÃªn GitHub..."
              attempts=0
              max_attempts=3
              
              while [ $attempts -lt $max_attempts ]; do
                if git push origin main; then
                  echo "âœ… Äáº©y thay Ä‘á»•i thÃ nh cÃ´ng!"
                  break
                else
                  attempts=$((attempts + 1))
                  echo "âš ï¸ Lá»—i khi Ä‘áº©y thay Ä‘á»•i (láº§n thá»­ $attempts/$max_attempts)"
                  
                  if [ $attempts -lt $max_attempts ]; then
                    echo "ğŸ”„ Äang Ä‘á»“ng bá»™ láº¡i vá»›i remote..."
                    git pull --rebase origin main
                    sleep 5
                  else
                    echo "âŒ ÄÃ£ thá»­ $max_attempts láº§n nhÆ°ng khÃ´ng thÃ nh cÃ´ng"
                  fi
                fi
              done
            else
              echo "â© KhÃ´ng cÃ³ thay Ä‘á»•i, bá» qua commit"
            fi
            
            echo "â³ Äá»£i 1 phÃºt trÆ°á»›c khi cháº¡y láº¡i..."
            sleep 60
          done

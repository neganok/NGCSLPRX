name: Setup Proxy Machine

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: 🛠️ Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          clean: true

      - name: 🔄 Cài đặt hệ thống
        run: |
          sudo apt update && sudo apt install -y python3 python3-pip python3-venv curl netcat-traditional

      - name: 🏰️ Thiết lập môi trường
        run: |
          python3 -m venv env
          source env/bin/activate
          pip install --upgrade pip
          test -f requirements.txt && pip install -r requirements.txt

      - name: 🚀 Khởi động proxy
        run: |
          source env/bin/activate
          nohup python3 start.py > start.log 2>&1 &
          sleep 15

      - name: 🔑 Cấu hình Git
        run: |
          git config --global user.name "neganok"
          git config --global user.email "hackersvn1@gmail.com"
          git config --global pull.rebase false

      - name: 🔄 Cập nhật proxy (ổn định)
        run: |
          set -e
          mkdir -p Proxies
          
          # Hàm tải proxy với retry và kiểm tra
          safe_proxy_download() {
            local type=$1
            local max_retries=3
            local timeout=10
            
            for ((i=1; i<=max_retries; i++)); do
              if curl -s --connect-timeout $timeout "http://127.0.0.1:8000/proxy/${type}?time=2&minutes=10&format=text" -o "Proxies/${type}.tmp" && 
                 [ -s "Proxies/${type}.tmp" ]; then
                mv "Proxies/${type}.tmp" "Proxies/${type}.txt"
                echo "✅ [$type] Tải thành công (lần $i)"
                return 0
              fi
              echo "⚠️ [$type] Lỗi lần $i, chờ 5s..."
              sleep 5
            done
            echo "❌ [$type] Không thể tải sau $max_retries lần"
            return 1
          }

          # Hàm push an toàn
          safe_git_push() {
            local max_attempts=3
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              git fetch origin
              git reset --hard origin/main
              
              if git diff --quiet && git diff --cached --quiet; then
                echo "ℹ️ Không có thay đổi để push"
                return 0
              fi
              
              git add -A
              git commit -m "🔄 Auto-update $(date +'%Y-%m-%d %H:%M:%S')" || true
              
              if git pull origin main --no-rebase && git push origin main; then
                echo "✅ Push thành công!"
                return 0
              else
                echo "⚠️ Push thất bại lần $attempt, đang reset..."
                git reset --hard HEAD~1 || true
                git clean -fd
                sleep 10
                ((attempt++))
              fi
            done
            
            echo "❌ Không thể push sau $max_attempts lần"
            return 1
          }

          # Vòng lặp chính
          for cycle in $(seq 1 300); do
            echo "🔄 Chu kỳ $cycle/300"
            
            # Kiểm tra proxy server
            if ! nc -z -w 10 127.0.0.1 8000; then
              echo "❌ Proxy chưa sẵn sàng, chờ 30s..."
              sleep 30
              continue
            fi

            # Tải tất cả proxy
            for proxy_type in http https socks4 socks5; do
              safe_proxy_download $proxy_type || continue
            done

            # Xử lý data.db nếu có
            [ -f "data.db" ] && git add data.db

            # Đồng bộ với Git
            safe_git_push || true
            
            sleep 60
          done

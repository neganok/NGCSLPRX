name: Proxy Master

on:
  schedule:
    - cron: '0 */5 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: C√†i ƒë·∫∑t m√¥i tr∆∞·ªùng
        run: |
          echo "üõ†Ô∏è ƒêang c√†i ƒë·∫∑t m√¥i tr∆∞·ªùng..."
          pip install -r requirements.txt
          nohup python3 start.py > start.log 2>&1 &
          sleep 10
          echo "‚úÖ C√†i ƒë·∫∑t m√¥i tr∆∞·ªùng ho√†n t·∫•t!"

      - name: C·∫≠p nh·∫≠t t·ª± ƒë·ªông
        run: |
          echo "‚öôÔ∏è Thi·∫øt l·∫≠p th√¥ng tin Git..."
          git config --global user.name "neganok"
          git config --global user.email "hackersvn1@gmail.com"
          
          COUNT=0
          while true; do
            COUNT=$((COUNT + 1))
            echo "\nüîÅ B·∫ÆT ƒê·∫¶U L·∫¶N CH·∫†Y TH·ª® $COUNT - $(date +'%H:%M:%S %d/%m/%Y')"
            
            # T·∫£i proxies
            echo "üì• ƒêang t·∫£i proxies m·ªõi..."
            mkdir -p Proxies
            for t in http https socks4 socks5; do
              echo "  ‚Ü≥ ƒêang t·∫£i $t..."
              curl -s "http://127.0.0.1:8000/proxy/$t?time=3&minutes=15&format=text" -o "Proxies/$t.txt" || echo "  ‚ùå L·ªói khi t·∫£i $t"
              # ƒê·∫øm s·ªë l∆∞·ª£ng proxy
              if [ -f "Proxies/$t.txt" ]; then
                count=$(wc -l < "Proxies/$t.txt")
                echo "  ‚û°Ô∏è ƒê√£ t·∫£i $count proxy $t"
              else
                echo "  ‚û°Ô∏è Kh√¥ng c√≥ proxy $t n√†o"
              fi
            done
            
            # X·ª≠ l√Ω Git
            echo "üîÑ ƒêang ki·ªÉm tra thay ƒë·ªïi..."
            git add Proxies/ data.db
            
            if ! git diff --cached --quiet; then
              echo "üìù Ph√°t hi·ªán thay ƒë·ªïi, ƒëang t·∫°o commit..."
              git commit -m "üîÑ C·∫≠p nh·∫≠t t·ª± ƒë·ªông l√∫c $(date +'%H:%M:%S %d/%m/%Y')"
              
              echo "üì§ ƒêang ƒë·∫©y thay ƒë·ªïi l√™n GitHub..."
              attempts=0
              max_attempts=3
              
              while [ $attempts -lt $max_attempts ]; do
                if git push origin main; then
                  echo "‚úÖ ƒê·∫©y thay ƒë·ªïi th√†nh c√¥ng!"
                  break
                else
                  attempts=$((attempts + 1))
                  echo "‚ö†Ô∏è L·ªói khi ƒë·∫©y thay ƒë·ªïi (l·∫ßn th·ª≠ $attempts/$max_attempts)"
                  
                  if [ $attempts -lt $max_attempts ]; then
                    echo "üîÑ ƒêang ƒë·ªìng b·ªô l·∫°i v·ªõi remote..."
                    git pull --rebase origin main
                    sleep 5
                  else
                    echo "‚ùå ƒê√£ th·ª≠ $max_attempts l·∫ßn nh∆∞ng kh√¥ng th√†nh c√¥ng"
                  fi
                fi
              done
            else
              echo "‚è© Kh√¥ng c√≥ thay ƒë·ªïi, b·ªè qua commit"
            fi
            
            echo "‚è≥ ƒê·ª£i 1 ph√∫t tr∆∞·ªõc khi ch·∫°y l·∫°i..."
            sleep 60
          done

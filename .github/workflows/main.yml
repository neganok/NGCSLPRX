name: Setup Proxy Machine

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'  # Ch·∫°y m·ªói 5 gi·ªù

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: C·∫≠p nh·∫≠t h·ªá th·ªëng v√† c√†i ƒë·∫∑t Python
        run: |
          sudo apt update && sudo apt install -y git python3-full python3-pip

      - name: Thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng ·∫£o v√† c√†i ƒë·∫∑t y√™u c·∫ßu
        run: |
          python3 -m venv env
          source env/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Ch·∫°y start.py v√† gi·ªØ ti·∫øn tr√¨nh ch·∫°y trong 5 gi·ªù
        run: |
          source env/bin/activate
          python3 start.py &

      - name: C·∫•u h√¨nh Git
        run: |
          git config --global user.name "neganok"
          git config --global user.email "hackersvn1@gmail.com"

      - name: C·∫≠p nh·∫≠t danh s√°ch proxy m·ªói ph√∫t trong 5 gi·ªù
        run: |
          for i in $(seq 1 300); do
            # T·∫£i proxy v√† ghi v√†o file http.txt
            curl -s 'http://127.0.0.1:8000/proxy/http?time=2&minutes=10&format=text' -o http.txt
            
            # Ki·ªÉm tra n·∫øu http.txt c√≥ d·ªØ li·ªáu th√¨ commit & push
            if [ -s http.txt ]; then
              echo "‚úÖ Proxy m·ªõi ƒë√£ t·∫£i, ti·∫øn h√†nh commit & push..."
              git add http.txt
              git commit -a -m "üîÑ C·∫≠p nh·∫≠t danh s√°ch proxy $(date)"
              git push origin main
            else
              echo "‚ùå Kh√¥ng c√≥ proxy m·ªõi, b·ªè qua commit."
            fi

            sleep 60  # Ch·ªù 1 ph√∫t tr∆∞·ªõc khi ti·∫øp t·ª•c
          done

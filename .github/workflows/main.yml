name: Proxy Master

on:
  schedule:
    - cron: '0 */5 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Clean workspace
        run: |
          sudo rm -rf *
          
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Start service
        run: |
          pip install -r requirements.txt
          nohup python3 start.py > start.log 2>&1 &
          sleep 10

      - name: Update and push
        run: |
          git config --global user.name "neganok"
          git config --global user.email "hackersvn1@gmail.com"
          
          # T·∫°o th∆∞ m·ª•c v√† l·∫•y proxy
          mkdir -p Proxies
          for t in http https socks4 socks5; do
            curl -s "http://127.0.0.1:8000/proxy/$t?time=3&minutes=15&format=text" -o "Proxies/$t.txt" || true
          done

          # Ch·ªâ th√™m file c·∫ßn thi·∫øt
          git add Proxies/ data.db
          
          # Commit v√† push n·∫øu c√≥ thay ƒë·ªïi
          if ! git diff --cached --quiet; then
            git commit -m "üîÑ Update $(date +'%H:%M')"
            
            # Push v·ªõi retry ƒë∆°n gi·∫£n
            for i in {1..3}; do
              if git pull origin main && git push origin main; then
                echo "‚úÖ ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng"
                exit 0
              fi
              sleep 5
            done
            
            echo "‚ùå Kh√¥ng th·ªÉ push sau 3 l·∫ßn th·ª≠"
            exit 1
          else
            echo "‚è≠ Kh√¥ng c√≥ thay ƒë·ªïi"
          fi

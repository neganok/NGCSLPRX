name: Setup Proxy Machine

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'  # Ch·∫°y m·ªói 5 gi·ªù

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: üõ†Ô∏è Checkout repository
        uses: actions/checkout@v3

      - name: üì¶ C·∫≠p nh·∫≠t h·ªá th·ªëng v√† c√†i ƒë·∫∑t Python
        run: |
          sudo apt update
          sudo apt install -y git python3-full python3-pip curl

      - name: üîß Thi·∫øt l·∫≠p m√¥i tr∆∞·ªùng ·∫£o v√† c√†i ƒë·∫∑t y√™u c·∫ßu
        run: |
          python3 -m venv env
          source env/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: üöÄ Ch·∫°y start.py v√† gi·ªØ ti·∫øn tr√¨nh ch·∫°y trong 5 gi·ªù
        run: |
          source env/bin/activate
          nohup python3 start.py > start.log 2>&1 &  # Ch·∫°y n·ªÅn tr√°nh b·ªã kill

      - name: üîë C·∫•u h√¨nh Git
        run: |
          git config --global user.name "neganok"
          git config --global user.email "hackersvn1@gmail.com"

      - name: üîÑ C·∫≠p nh·∫≠t danh s√°ch proxy m·ªói ph√∫t trong 5 gi·ªù
        run: |
          for i in $(seq 1 300); do
            echo "üîÑ [L·∫ßn $i] ƒêang t·∫£i danh s√°ch proxy..."

            # Ki·ªÉm tra m√°y ch·ªß proxy c√≥ ho·∫°t ƒë·ªông kh√¥ng
            nc -z 127.0.0.1 8000
            if [ $? -ne 0 ]; then
              echo "‚ùå M√°y ch·ªß proxy ch∆∞a ch·∫°y, ch·ªù 1 ph√∫t..."
              sleep 60
              continue
            fi

            # T·∫£i proxy, n·∫øu l·ªói th√¨ b·ªè qua l·∫ßn n√†y
            curl -s --connect-timeout 5 'http://127.0.0.1:8000/proxy/http?time=2&minutes=10&format=text' -o http.txt || {
              echo "‚ö†Ô∏è L·ªói khi t·∫£i proxy, b·ªè qua l·∫ßn n√†y."
              sleep 60
              continue
            }

            # Ki·ªÉm tra n·∫øu http.txt c√≥ d·ªØ li·ªáu th√¨ commit & push
            if [ -s http.txt ]; then
              echo "‚úÖ Proxy m·ªõi ƒë√£ t·∫£i, ti·∫øn h√†nh commit & push..."
              git add http.txt
              git commit -m "üîÑ C·∫≠p nh·∫≠t danh s√°ch proxy $(date)" || echo "‚ö†Ô∏è Kh√¥ng c√≥ thay ƒë·ªïi, b·ªè qua commit."
              git push origin main || echo "‚ö†Ô∏è Kh√¥ng th·ªÉ ƒë·∫©y l√™n repo, th·ª≠ l·∫°i l·∫ßn sau."
            else
              echo "‚ùå Kh√¥ng c√≥ proxy m·ªõi, b·ªè qua commit."
            fi

            sleep 60  # Ch·ªù 1 ph√∫t tr∆∞·ªõc khi ti·∫øp t·ª•c
          done

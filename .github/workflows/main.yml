name: Setup Proxy Machine

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: '0 */5 * * *'  # Chạy mỗi 5 giờ

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Cập nhật hệ thống và cài đặt Python
        run: |
          sudo apt update && sudo apt install -y git python3-full python3-pip

      - name: Thiết lập môi trường ảo và cài đặt yêu cầu
        run: |
          python3 -m venv env
          source env/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Chạy start.py và giữ tiến trình chạy trong 5 giờ
        run: |
          source env/bin/activate
          python3 start.py &

      - name: Cấu hình Git
        run: |
          git config --global user.name "neganok"
          git config --global user.email "hackersvn1@gmail.com"

      - name: Cập nhật danh sách proxy mỗi phút trong 5 giờ
        run: |
          for i in $(seq 1 300); do
            echo "" > http.txt  # Xóa nội dung cũ trong file
            curl -s 'http://127.0.0.1:8000/proxy/http?time=2&minutes=10&format=text' -o http.txt || echo "Lỗi tải proxy"

            if [ -s http.txt ]; then
              echo "Proxy đã tải:"
              cat http.txt
              
              # Kiểm tra nếu có thay đổi thì mới commit
              if ! git diff --quiet http.txt; then
                git add http.txt
                git commit -m "Cập nhật danh sách proxy mới"
                git push origin main
              else
                echo "Không có thay đổi, bỏ qua commit."
              fi
            else
              echo "Không có proxy, bỏ qua commit."
            fi

            sleep 60  # Chờ 1 phút trước khi lặp lại
          done
